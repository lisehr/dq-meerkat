{"version":3,"sources":["webpack:///./public/app/features/profile/ChangePasswordForm.tsx","webpack:///./public/app/features/profile/ChangePasswordPage.tsx","webpack:///./public/app/core/utils/UserProvider.tsx","webpack:///./public/app/core/components/ForgottenPassword/ChangePasswordPage.tsx"],"names":["ChangePasswordForm","user","onChangePassword","isSaving","ldapEnabled","config","authProxyEnabled","disableLoginForm","authSource","authLabels","length","className","css","onSubmit","register","errors","getValues","label","invalid","oldPassword","error","message","type","name","ref","required","newPassword","validate","confirm","v","confirmNew","old","variant","disabled","href","appSubUrl","ChangePasswordPage","navModel","userId","bootData","id","api","states","teams","orgs","sessions","Contents","loadUser","text","changePassword","hot","module","connect","state","getNavModel","navIndex","UserProvider","loadingStates","loadTeams","loadOrgs","loadSessions","updateUserProfile","updateUserOrg","payload","setState","getBackendSrv","put","get","Object","keys","then","sort","a","b","Number","isActive","map","session","seenAt","dateTimeFormatTimeAgo","createdAt","dateTimeFormat","format","clientIp","browser","browserVersion","os","osVersion","device","revokeUserSession","tokenId","post","authTokenId","filter","setUserOrg","org","orgId","window","location","finally","catch","e","console","this","props","children","PureComponent"],"mappings":"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","file":"ChangePasswordPage.1c3a1c85d09a392be724.js","sourcesContent":["import React, { FC } from 'react';\nimport config from 'app/core/config';\nimport { UserDTO } from 'app/types';\nimport { Button, LinkButton, Form, Field, Input, HorizontalGroup } from '@grafana/ui';\nimport { ChangePasswordFields } from 'app/core/utils/UserProvider';\nimport { css } from 'emotion';\n\nexport interface Props {\n  user: UserDTO;\n  isSaving: boolean;\n  onChangePassword: (payload: ChangePasswordFields) => void;\n}\n\nexport const ChangePasswordForm: FC<Props> = ({ user, onChangePassword, isSaving }) => {\n  const { ldapEnabled, authProxyEnabled, disableLoginForm } = config;\n  const authSource = user.authLabels?.length && user.authLabels[0];\n\n  if (ldapEnabled || authProxyEnabled) {\n    return <p>You cannot change password when ldap or auth proxy authentication is enabled.</p>;\n  }\n  if (authSource && disableLoginForm) {\n    return <p>Password cannot be changed here!</p>;\n  }\n\n  return (\n    <div\n      className={css`\n        max-width: 400px;\n      `}\n    >\n      <Form onSubmit={onChangePassword}>\n        {({ register, errors, getValues }) => {\n          return (\n            <>\n              <Field label=\"Old password\" invalid={!!errors.oldPassword} error={errors?.oldPassword?.message}>\n                <Input type=\"password\" name=\"oldPassword\" ref={register({ required: 'Old password is required' })} />\n              </Field>\n\n              <Field label=\"New password\" invalid={!!errors.newPassword} error={errors?.newPassword?.message}>\n                <Input\n                  type=\"password\"\n                  name=\"newPassword\"\n                  ref={register({\n                    required: 'New password is required',\n                    validate: {\n                      confirm: (v) => v === getValues().confirmNew || 'Passwords must match',\n                      old: (v) => v !== getValues().oldPassword || `New password can't be the same as the old one.`,\n                    },\n                  })}\n                />\n              </Field>\n\n              <Field label=\"Confirm password\" invalid={!!errors.confirmNew} error={errors?.confirmNew?.message}>\n                <Input\n                  type=\"password\"\n                  name=\"confirmNew\"\n                  ref={register({\n                    required: 'New password confirmation is required',\n                    validate: (v) => v === getValues().newPassword || 'Passwords must match',\n                  })}\n                />\n              </Field>\n              <HorizontalGroup>\n                <Button variant=\"primary\" disabled={isSaving}>\n                  Change Password\n                </Button>\n                <LinkButton variant=\"secondary\" href={`${config.appSubUrl}/profile`}>\n                  Cancel\n                </LinkButton>\n              </HorizontalGroup>\n            </>\n          );\n        }}\n      </Form>\n    </div>\n  );\n};\n","import React, { FC } from 'react';\nimport { hot } from 'react-hot-loader';\nimport { connect } from 'react-redux';\nimport { config } from '@grafana/runtime';\nimport { LoadingPlaceholder } from '@grafana/ui';\nimport { UserDTO, Team, UserOrg, UserSession, StoreState } from 'app/types';\nimport { NavModel } from '@grafana/data';\nimport { getNavModel } from 'app/core/selectors/navModel';\nimport { UserProvider, UserAPI, LoadingStates } from 'app/core/utils/UserProvider';\nimport Page from 'app/core/components/Page/Page';\nimport { ChangePasswordForm } from './ChangePasswordForm';\n\nexport interface Props {\n  navModel: NavModel;\n}\n\nexport const ChangePasswordPage: FC<Props> = ({ navModel }) => (\n  <Page navModel={navModel}>\n    <UserProvider userId={config.bootData.user.id}>\n      {(\n        api: UserAPI,\n        states: LoadingStates,\n        teams: Team[],\n        orgs: UserOrg[],\n        sessions: UserSession[],\n        user?: UserDTO\n      ) => {\n        return (\n          <Page.Contents>\n            <h3 className=\"page-sub-heading\">Change Your Password</h3>\n            {states.loadUser ? (\n              <LoadingPlaceholder text=\"Loading user profile...\" />\n            ) : (\n              <ChangePasswordForm user={user!} onChangePassword={api.changePassword} isSaving={states.changePassword} />\n            )}\n          </Page.Contents>\n        );\n      }}\n    </UserProvider>\n  </Page>\n);\n\nfunction mapStateToProps(state: StoreState) {\n  return {\n    navModel: getNavModel(state.navIndex, `change-password`),\n  };\n}\n\nconst mapDispatchToProps = {};\n\nexport default hot(module)(connect(mapStateToProps, mapDispatchToProps)(ChangePasswordPage));\n","import React, { PureComponent } from 'react';\nimport { getBackendSrv } from '@grafana/runtime';\nimport { UserDTO, Team, UserOrg, UserSession } from 'app/types';\nimport { config } from 'app/core/config';\nimport { dateTimeFormat, dateTimeFormatTimeAgo } from '@grafana/data';\n\nexport interface UserAPI {\n  changePassword: (changePassword: ChangePasswordFields) => void;\n  updateUserProfile: (profile: ProfileUpdateFields) => void;\n  loadUser: () => void;\n  loadTeams: () => void;\n  loadOrgs: () => void;\n  loadSessions: () => void;\n  setUserOrg: (org: UserOrg) => void;\n  revokeUserSession: (tokenId: number) => void;\n}\n\nexport interface LoadingStates {\n  changePassword: boolean;\n  loadUser: boolean;\n  loadTeams: boolean;\n  loadOrgs: boolean;\n  loadSessions: boolean;\n  updateUserProfile: boolean;\n  updateUserOrg: boolean;\n}\n\nexport interface ChangePasswordFields {\n  oldPassword: string;\n  newPassword: string;\n  confirmNew: string;\n}\n\nexport interface ProfileUpdateFields {\n  name: string;\n  email: string;\n  login: string;\n}\n\nexport interface Props {\n  userId?: number; // passed, will load user on mount\n  children: (\n    api: UserAPI,\n    states: LoadingStates,\n    teams: Team[],\n    orgs: UserOrg[],\n    sessions: UserSession[],\n    user?: UserDTO\n  ) => JSX.Element;\n}\n\nexport interface State {\n  user?: UserDTO;\n  teams: Team[];\n  orgs: UserOrg[];\n  sessions: UserSession[];\n  loadingStates: LoadingStates;\n}\n\nexport class UserProvider extends PureComponent<Props, State> {\n  state: State = {\n    teams: [] as Team[],\n    orgs: [] as UserOrg[],\n    sessions: [] as UserSession[],\n    loadingStates: {\n      changePassword: false,\n      loadUser: true,\n      loadTeams: false,\n      loadOrgs: false,\n      loadSessions: false,\n      updateUserProfile: false,\n      updateUserOrg: false,\n    },\n  };\n\n  UNSAFE_componentWillMount() {\n    if (this.props.userId) {\n      this.loadUser();\n    }\n  }\n\n  changePassword = async (payload: ChangePasswordFields) => {\n    this.setState({ loadingStates: { ...this.state.loadingStates, changePassword: true } });\n    await getBackendSrv().put('/api/user/password', payload);\n    this.setState({ loadingStates: { ...this.state.loadingStates, changePassword: false } });\n  };\n\n  loadUser = async () => {\n    this.setState({\n      loadingStates: { ...this.state.loadingStates, loadUser: true },\n    });\n    const user = await getBackendSrv().get('/api/user');\n    this.setState({ user, loadingStates: { ...this.state.loadingStates, loadUser: Object.keys(user).length === 0 } });\n  };\n\n  loadTeams = async () => {\n    this.setState({\n      loadingStates: { ...this.state.loadingStates, loadTeams: true },\n    });\n    const teams = await getBackendSrv().get('/api/user/teams');\n    this.setState({ teams, loadingStates: { ...this.state.loadingStates, loadTeams: false } });\n  };\n\n  loadOrgs = async () => {\n    this.setState({\n      loadingStates: { ...this.state.loadingStates, loadOrgs: true },\n    });\n    const orgs = await getBackendSrv().get('/api/user/orgs');\n    this.setState({ orgs, loadingStates: { ...this.state.loadingStates, loadOrgs: false } });\n  };\n\n  loadSessions = async () => {\n    this.setState({\n      loadingStates: { ...this.state.loadingStates, loadSessions: true },\n    });\n\n    await getBackendSrv()\n      .get('/api/user/auth-tokens')\n      .then((sessions: UserSession[]) => {\n        sessions = sessions\n          // Show active sessions first\n          .sort((a, b) => Number(b.isActive) - Number(a.isActive))\n          .map((session: UserSession) => {\n            return {\n              id: session.id,\n              isActive: session.isActive,\n              seenAt: dateTimeFormatTimeAgo(session.seenAt),\n              createdAt: dateTimeFormat(session.createdAt, { format: 'MMMM DD, YYYY' }),\n              clientIp: session.clientIp,\n              browser: session.browser,\n              browserVersion: session.browserVersion,\n              os: session.os,\n              osVersion: session.osVersion,\n              device: session.device,\n            };\n          });\n\n        this.setState({ sessions, loadingStates: { ...this.state.loadingStates, loadSessions: false } });\n      });\n  };\n\n  revokeUserSession = async (tokenId: number) => {\n    await getBackendSrv()\n      .post('/api/user/revoke-auth-token', {\n        authTokenId: tokenId,\n      })\n      .then(() => {\n        const sessions = this.state.sessions.filter((session: UserSession) => {\n          return session.id !== tokenId;\n        });\n\n        this.setState({ sessions });\n      });\n  };\n\n  setUserOrg = async (org: UserOrg) => {\n    this.setState({\n      loadingStates: { ...this.state.loadingStates, updateUserOrg: true },\n    });\n    await getBackendSrv()\n      .post('/api/user/using/' + org.orgId, {})\n      .then(() => {\n        window.location.href = config.appSubUrl + '/profile';\n      })\n      .finally(() => {\n        this.setState({ loadingStates: { ...this.state.loadingStates, updateUserOrg: false } });\n      });\n  };\n\n  updateUserProfile = async (payload: ProfileUpdateFields) => {\n    this.setState({ loadingStates: { ...this.state.loadingStates, updateUserProfile: true } });\n    await getBackendSrv()\n      .put('/api/user', payload)\n      .then(this.loadUser)\n      .catch((e) => console.error(e))\n      .finally(() => {\n        this.setState({ loadingStates: { ...this.state.loadingStates, updateUserProfile: false } });\n      });\n  };\n\n  render() {\n    const { children } = this.props;\n    const { loadingStates, teams, orgs, sessions, user } = this.state;\n\n    const api: UserAPI = {\n      changePassword: this.changePassword,\n      loadUser: this.loadUser,\n      loadTeams: this.loadTeams,\n      loadOrgs: this.loadOrgs,\n      loadSessions: this.loadSessions,\n      revokeUserSession: this.revokeUserSession,\n      updateUserProfile: this.updateUserProfile,\n      setUserOrg: this.setUserOrg,\n    };\n\n    return <>{children(api, loadingStates, teams, orgs, sessions, user)}</>;\n  }\n}\n\nexport default UserProvider;\n","import React, { FC } from 'react';\nimport { LoginLayout, InnerBox } from '../Login/LoginLayout';\nimport { ChangePassword } from './ChangePassword';\nimport LoginCtrl from '../Login/LoginCtrl';\n\nexport const ChangePasswordPage: FC = () => {\n  return (\n    <LoginLayout>\n      <InnerBox>\n        <LoginCtrl>{({ changePassword }) => <ChangePassword onSubmit={changePassword} />}</LoginCtrl>\n      </InnerBox>\n    </LoginLayout>\n  );\n};\n\nexport default ChangePasswordPage;\n"],"sourceRoot":""}